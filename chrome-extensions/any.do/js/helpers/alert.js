define(["chrome/helpers","underscore"],function(h,g){var a={alarms:{}};window.self=a;a.prepareReminder=function(c,e){var b=a.tasks._byId[c];if(b)if(b.get("status")!=TaskStatus.UNCHECKED||!b.get("alert")||"NONE"==b.get("alert").type)e=JSON.stringify({taskId:b.id,due:b.get("dueDate")}),a.removeAlarm(e);else{if(a.alarms[e]){var d=a.nextAlertTime(b);console.log("preparing reminder for",b,"secondsLeft are",d,"alerts are");if(0>d&&-3600<d){delete a.alarms[e];console.log("%c ~~~ POPUP for","background: yellow; font-weight: bold;",
e);var d=new Date(b.get("dueDate")),f=(10>d.getHours()?"0":"")+d.getHours()+":"+(10>d.getMinutes()?"0":"")+d.getMinutes(),b={id:b.id,category:a.categories.get(b.get("categoryId")).get("name"),alertTime:+d,formattedTime:f,title:b.get("title"),linkUrl:b.get("linkUrl")};h.showAlert(b)}else console.log("Ignoring alert with secondsLeft",d)}}else console.warn("No such task",c)};a.nextAlertTime=function(c){var a=c.get("alert"),b=c.get("dueDate");c.get("status");return!a||"NONE"==a.type?null:(b-a.offset-
Date.now())/1E3};a.checkReminders=function(){$.get("chrome-extension://"+getMessage("@@extension_id")+"/dummy");var c=g.clone(a.alarms);g.each(c,function(c,b){if(c){var d=JSON.parse(b);console.log("Checking alarm",d,new Date(d.due));a.prepareReminder(d.taskId,b)}})};a.updateReminder=function(c){var e=c.get("alert");c.get("id");var b=c.get("dueDate"),b=JSON.stringify({taskId:c.id,due:b});if(e&&"OFFSET"==e.type&&c.get("status")==TaskStatus.UNCHECKED){var d=a.tasks._byId[c.id],f=c.get("dueDate")-1E3*
e.offset;if(-3600>a.nextAlertTime(c))a.removeAlarm(b);else if("object"==typeof c.attributes?d.set(c.attributes,{silent:!0}):(delete c.get,d.set(c,{silent:!0})),!a.alarms[b])a.alarms[b]=!0,console.log("creating alert",c,e,"alarm time:",f)}else a.removeAlarm(b)};a.updateReminders=function(c,e,b){console.log("%c updateReminders called","background: lime;",b?b:"");a.tasks=e;a.categories=c;c=e.getTopLevelTasks();if(b){b.get=function(a){return b[a]};var d=b.get("id");a.tasks._byId[d]?a.updateReminder(b):
console.warn("Sorry, didn't found this task",d)}else for(d in c)a.updateReminder(c[d])};a.removeAlarm=function(c){a.alarms[c]&&delete a.alarms[c]};return a});