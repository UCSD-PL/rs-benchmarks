define("jquery,underscore,backbone,models/task,constants,config/user".split(","),function(l,c,i,j,m,k){return i.Collection.extend({url:TASKS_URL,model:j,getLeftTasks:function(){return c.select(this.getTasksInDueDate(DATE_CATEGORY_TODAY),function(a){return a.get("status")==TaskStatus.UNCHECKED})},getTasksInCategory:function(a){return this.select(function(b){return a==b.get("categoryId")&&b.validStatus()&&b.get("parentGlobalTaskId")==null},this)},getTasksInDueDate:function(a){return this.select(function(b){return a==
b.getMatchingDueDateCategory()&&b.validStatus()&&b.get("parentGlobalTaskId")==null},this)},getTasksInPriority:function(a){return this.select(function(b){return a==b.get("priority")&&b.validStatus()&&b.get("parentGlobalTaskId")==null},this)},getTopLevelTasks:function(){return this.select(function(a){return a.get("parentGlobalTaskId")==null&&a.validStatus()},this)},getExpandedTasks:function(){return this.select(function(a){return a.get("taskExpanded")===true&&a.validStatus()},this)},fixListPositions:function(a){var b=
0;c.each(a,c.bind(function(a){a=this.getTasksInCategory(a.id);a=c.sortBy(a,function(a){return a.get(LIST_POSITION_KEY[VIEW_BY_CATEGORY])});b=0;c.each(a,function(a){var e={};e[LIST_POSITION_KEY[VIEW_BY_CATEGORY]]=b;a.set(e);b++})},this));c.each(TaskPriority,c.bind(function(a){a=this.getTasksInPriority(a);a=c.sortBy(a,function(a){return a.get(LIST_POSITION_KEY[VIEW_BY_PRIORITY])});b=0;c.each(a,function(a){var e={};e[LIST_POSITION_KEY[VIEW_BY_PRIORITY]]=b;a.set(e);b++})},this));for(var d in DATES){a=
this.getTasksInDueDate(DATES[d]);a=c.sortBy(a,function(a){return a.get(LIST_POSITION_KEY[VIEW_BY_DUE_DATE])});b=0;c.each(a,function(a){var d={};d[LIST_POSITION_KEY[VIEW_BY_DUE_DATE]]=b;a.set(d);b++})}},getTopLevelTasksInACategory:function(a,b){var d;switch(a){case VIEW_BY_DUE_DATE:d=this.select(function(a){return a.get("parentGlobalTaskId")==void 0&&b==a.getMatchingDueDateCategory()&&a.validStatus()},this);break;case VIEW_BY_PRIORITY:d=this.select(function(a){return a.get("parentGlobalTaskId")==void 0&&
a.validStatus()&&b==a.get("priority")},this);break;case VIEW_BY_CATEGORY:d=this.select(function(a){return a.get("parentGlobalTaskId")==void 0&&b==a.get("categoryId")&&a.validStatus()},this)}return c.sortBy(d,function(b){return b.getListPosition(a)})},getNotes:function(a){return this.select(function(b){return a.id==b.get("parentGlobalTaskId")&&b.validStatus()},this)},getUncheckedNotes:function(a){return this.select(function(b){return a.id==b.get("parentGlobalTaskId")&&b.get("status")==TaskStatus.UNCHECKED},
this)},clearCompleted:function(){c.each(this.models,function(a){if(a.get("status")==TaskStatus.CHECKED){var b=a.get("parentGlobalTaskId")==void 0?TaskStatus.DONE:TaskStatus.DELETED;a.save({status:b})}},this)},initialize:function(){c.bindAll(this,"addTask");this.bind("add",this.addTask)},addTask:function(a){if(a.get("parentGlobalTaskId")==void 0){this.shiftTasks(VIEW_BY_CATEGORY,null,a,1);this.shiftTasks(VIEW_BY_DUE_DATE,null,a,1);this.shiftTasks(VIEW_BY_PRIORITY,null,a,1)}},deleteTask:function(a){if(a.get("parentGlobalTaskId")==
void 0){this.shiftTasks(VIEW_BY_CATEGORY,a.get(LIST_POSITION_KEY[VIEW_BY_CATEGORY]),a,-1);this.shiftTasks(VIEW_BY_DUE_DATE,a.get(LIST_POSITION_KEY[VIEW_BY_DUE_DATE]),a,-1);this.shiftTasks(VIEW_BY_PRIORITY,a.get(LIST_POSITION_KEY[VIEW_BY_PRIORITY]),a,-1)}},shiftTasks:function(a,b,d,e){var f;switch(a){case VIEW_BY_CATEGORY:f=this.getTasksInCategory(d.get("categoryId"));break;case VIEW_BY_DUE_DATE:f=this.getTasksInDueDate(d.getMatchingDueDateCategory());break;case VIEW_BY_PRIORITY:f=this.getTasksInPriority(d.get("priority"))}f=
c.sortBy(f,function(b){return b.getListPosition(a)});c.each(f,function(c){var f=c.get(LIST_POSITION_KEY[a]);if(c!=d&&(f>=b||b==null)){var h={};h[LIST_POSITION_KEY[a]]=f+e;c.save(h,{silent:true})}})},dropTaskIntoCategory:function(a,b,d){this.shiftTasks(a,b.get(LIST_POSITION_KEY[a]),b,-1);switch(a){case VIEW_BY_CATEGORY:b.setFolderCategory(d);break;case VIEW_BY_DUE_DATE:b.setDueDateCategory(d);break;case VIEW_BY_PRIORITY:b.setPriorityCategory(d)}this.shiftTasks(a,0,b,1)},dropTaskIntoTask:function(a,
b,d,e){this.shiftTasks(a,b.get(LIST_POSITION_KEY[a]),b,-1);switch(a){case VIEW_BY_CATEGORY:b.save({categoryId:d.get("categoryId")});break;case VIEW_BY_DUE_DATE:b.setDueDateCategory(d.getMatchingDueDateCategory());break;case VIEW_BY_PRIORITY:b.save({priority:d.get("priority")})}var c=d.get(LIST_POSITION_KEY[a])+(e?0:1);this.shiftTasks(a,c,b,1);var g={},c=d.get(LIST_POSITION_KEY[a])+(e?-1:1);g[LIST_POSITION_KEY[a]]=c;b.save(g)},generateDueDate:function(a){this.userConfig=new k;var b=this.userConfig.getCalendarDay(),
d=new Date;d.setHours(10);d.setMinutes(0);d.setSeconds(0);var c=d.getTime();switch(a){case DATE_CATEGORY_TODAY:c=0;break;case DATE_CATEGORY_TOMORROW:c=c+DAY_SECONDS;break;case DATE_CATEGORY_UPCOMING:b==7&&(b=0);console.log("ok, week start is:",b);a=c;c=d.setDate(d.getDate()+6+b-d.getDay());c-a==864E5&&(c=c+DAY_SECONDS*7);break;case DATE_CATEGORY_SOMEDAY:return;default:c=+a}console.log("generated due date",new Date(c));return new Date(c)},collapseAll:function(){c.each(this.getExpandedTasks(),function(a){a.save({taskExpanded:false})},
this)}})});