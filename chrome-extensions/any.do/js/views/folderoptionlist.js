define("jquery,underscore,mustache,backbone,constants,text!templates/folder_options.html".split(","),function(a,e,g,h,j,i){return h.View.extend({tagName:"div",className:"folders-chooser",events:{"click .text":"itemClick","click .delete-button":"deleteCategory","click .edit-button":"editCategory","keydown .new-folder":"newFolderEntered","keydown .edit-box":"editBoxEntered","click .popover-background":"leave"},initialize:function(){e.bindAll(this,"leave","itemClick","selectAndClose","selectListViewItem",
"close","render");this.categories=this.options.app.categories;this.categories.bind("add",this.render);this.categories.bind("destroy",this.render)},render:function(){var b=[];if(this.options.target.length)if(a(this.options.target).offset().left==0&&a(this.options.target).offset().top==0)this.remove();else{e.each(this.categories.models,function(a){var d=a.get("name"),c=true;a.get("isDefault")&&(c=false);b.push({id:a.id,text:d,selected:a.id==this.options.selectedItem,canBeDeleted:c})},this);var d=g.i18n_to_html(i,
["choose_folder","new_folder"],{categories:b});a(this.el).html(d);a(document.body).append(this.el);var d=a(this.options.target).offset().left+a(this.options.target).width()/2,c=a(this.options.target).offset().top+a(this.options.target).height()/2;this.popoverWindow=a(this.el).find(".popover-window");this.popoverAnchor=this.popoverWindow.find(".popover-anchor");var f=false;c-this.popoverWindow.height()<10&&(f=true);this.popoverWindow.css("left",d-this.popoverWindow.find("ul").width()/2-2);this.popoverAnchor.css("left",
this.popoverWindow.find("ul").width()/2-2);if(f){this.popoverAnchor.removeClass("popover-anchor-top").addClass("popover-anchor-bottom");this.popoverWindow.css("top",c+5);this.popoverAnchor.css("top",-9)}else{this.popoverAnchor.removeClass("popover-anchor-bottom").addClass("popover-anchor-top");this.popoverWindow.css("top",c-this.popoverWindow.height()-20);this.popoverAnchor.css("top",this.popoverWindow.height()-7)}this.first=this.popoverWindow.find("li:first");this.last=this.popoverWindow.find("li:last");
this.selectedItem=this.popoverWindow.find(".selected");this.selectedItem.focus();this.selectListViewItem();return this}else this.remove()},itemClick:function(b){this.stopEditing();this.selectedItem=a(b.target);this.selectListViewItem();a(this.el).fadeOut("fast",this.selectAndClose)},deleteCategory:function(b){this.categories.get(a(b.target).parent().data("id")).destroy()},editCategory:function(b){b=a(b.target).parent("li");this.currentlyEditing=true;this.editingText=b.find(".text");this.editingInput=
b.find(".edit-box");this.editingCategory=b.data("id");this.startEditing()},startEditing:function(){this.editingText.hide();this.editingInput.show();this.editingInput.focus()},stopEditing:function(){if(this.currentlyEditing){this.currentlyEditing=false;if(this.editingText.text()!=this.editingInput.val()){this.categories.get(this.editingCategory).save({name:this.editingInput.val()});this.editingText.text(this.editingInput.val())}this.editingText.show();this.editingInput.hide()}},editBoxEntered:function(a){switch(a.keyCode){case 13:this.stopEditing();
break;case 27:this.editingInput.val(this.editingText.text());this.stopEditing()}},selectAndClose:function(){this.stopEditing();this.selectedItem.parent().data("id")==this.model.id?this.options.callback():this.model.collection.dropTaskIntoCategory(VIEW_BY_CATEGORY,this.model,this.selectedItem.parent().data("id"));this.remove()},leave:function(){a(this.el).fadeOut("fast",this.close);this.options.callback()},close:function(){this.categories.unbind("add",this.render);this.categories.unbind("destroy",
this.render);this.stopEditing();this.remove()},newFolderEntered:function(b){switch(b.keyCode){case 13:b=a(this.el).find(".new-folder").val();if(this.categories.getCategoryByName(b)||a.trim(b).length==0)break;b=this.categories.create({name:b});a(this.el).find(".new-folder").val("");this.options.model.save({categoryId:b.id});this.render();break;case 27:this.leave()}},selectListViewItem:function(){a(this.el).children().removeClass("selected");this.selectedItem.find(".delete-button").addClass("selected")}})});