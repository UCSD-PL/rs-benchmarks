require.config({baseUrl:"/js",paths:{jquery:"libs/jquery/jquery-min",underscore:"libs/underscore/underscore",backbone:"libs/backbone/backbone",text:"libs/require/text",less:"libs/less",iscroll:"libs/iscroll",base64:"libs/base64",mustache:"libs/mustache/mustache"}});window.storage=localStorage;window.getMessage=chrome.i18n.getMessage;var extensionVersion=chrome.app.getDetails().version;
"undefined"!==typeof chrome.runtime&&chrome.runtime.onInstalled.addListener(function(c){console.log("extension install/updated. details: ",c);storage.setItem("isNewInstall",c.reason);"install"==c.reason&&storage.setItem("forceLogout","true")});chrome.manifest=chrome.app.getDetails();var injectIntoTab=function(c){for(var j=chrome.manifest.content_scripts[1].js,k=0,l=j.length;k<l;k++)chrome.tabs.executeScript(c.id,{file:j[k]})};
chrome.windows.getAll({populate:!0},function(c){for(var j=0,k=c.length,l;j<k;j++){l=c[j];for(var m=0,z=l.tabs.length,h;m<z;m++)h=l.tabs[m],h.url.match(/^https:\/\/mail\.google\.com/gi)&&injectIntoTab(h)}});
require("jquery,underscore,collections/task,collections/category,server/auth,server/sync,chrome/helpers,helpers/alert,constants,config/user".split(","),function(c,j,k,l,m,z,h,t,O,I){function A(){f&&t.checkReminders()}function B(a,b,i,d){var c=a.alert||null,e=a.linkUrl||null;if(f){console.log("task details:",a,"due date:",tasks.generateDueDate(b),JSON.stringify(a));tasks.create({title:a.title,categoryId:categories.getDefaultCategory().id||null,dueDate:+tasks.generateDueDate(b),alert:c,linkUrl:e},{success:function(){typeof i===
"function"&&i.apply(this,arguments);n()},error:function(a){typeof d==="function"&&d.apply(this,arguments);if(a.status==409){alert("You must log in to Any.DO first.");typeof d==="function"&&d({errorReason:"loggedOut"})}else{alert("There was an error with our servers... Please try again later. Error: "+a.status);typeof d==="function"&&d()}}})}else typeof d==="function"&&d({errorReason:"loggedOut"})}function J(){var a=storage.getItem("userPuid");if(a!=null){window.storage.removeItem("password");u("AnyDO-Puid",
a);v()}else c.ajax({url:ME_URL,type:"get",xhrFields:{withCredentials:true},crossDomain:true,success:function(a){storage.setItem("userPuid",a.id);u("AnyDO-Puid",a.id);v()},error:v})}function q(){return((1+Math.random())*65536|0).toString(16).substring(1)}function u(a,b){c(document).on("ajaxSend",function(i,d){d.setRequestHeader(a,b)})}function K(){function a(a,b,c){a=a.linkUrl||a.selectionText||a.srcUrl||a.pageUrl;_gaq.push(["_trackEvent","Context Menu","Task Added"]);B({title:a},c)}console.log("Background page: initializing context menu.");
chrome.contextMenus.removeAll();var b=chrome.contextMenus.create({type:"normal",title:getMessage("context_add_to_anydo"),contexts:["all"]});chrome.contextMenus.create({parentId:b,type:"normal",title:getMessage("date_today"),contexts:["all"],onclick:function(b,d){a(b,d,DATE_CATEGORY_TODAY)}});chrome.contextMenus.create({parentId:b,type:"normal",title:getMessage("date_tomorrow"),contexts:["all"],onclick:function(b,d){a(b,d,DATE_CATEGORY_TOMORROW)}});chrome.contextMenus.create({parentId:b,type:"normal",
title:getMessage("date_upcoming"),contexts:["all"],onclick:function(b,d){a(b,d,DATE_CATEGORY_UPCOMING)}});chrome.contextMenus.create({parentId:b,type:"normal",title:getMessage("date_someday"),contexts:["all"],onclick:function(b,d){a(b,d,DATE_CATEGORY_SOMEDAY)}})}function n(a){f&&(a===void 0?h.updateTaskCounter(tasks.getLeftTasks().length):h.updateTaskCounter(a))}function C(){var a=[];a[0]=g.getGmailActive()?"1":"0";a[1]=g.getCalendarDay().toString();a[2]=g.getView()==VIEW_BY_DUE_DATE?"0":g.getView()==
VIEW_BY_CATEGORY?"1":g.getView()==VIEW_BY_PRIORITY?"2":"#";console.log("bitFlag",a.join(""));return a.join("")}function v(){var a=storage.getItem("isNewInstall");console.log("Install reason is",a);if(a=="install"){console.log("reporting installation for user",storage.getItem("userPuid"));c.ajax({url:ME_URL,type:"put",contentType:"application/json",data:JSON.stringify({id:storage.getItem("userPuid"),name:storage.getItem("userName"),instDetails:{installationId:btoa((q()+q()+"-"+q()+"-"+q()).slice(2)),
version_code:extensionVersion,platform:"WEB",userSettings:C()}}),crossDomain:true});a=new Date;a=""+a.getUTCFullYear()+(a.getUTCMonth()+1)+a.getUTCDate();_gaq.push(["_setCustomVar",5,"Installed",a,1]);storage.removeItem("isNewInstall");D()}}function E(){f=true;e||n();console.log("%c TASKS FETCHED!","font-size: 18px; font-weight: bold;");f&&t.updateReminders(categories,tasks,void 0)}function r(){if(f)console.log("Initialization already done.");else{_gaq.push(["_setCustomVar",2,"Settings Flags",C(),
1]);console.log("Background page: logging in.");J();K();tasks=new k;categories=new l;categories.fetch();tasks.fetch(F)}}function o(){if(f){categories.fetch();tasks.fetch(F)}}function D(){f=false;console.log("Background page: logging out.",tasks);h.updateTaskCounter(0);chrome.contextMenus.removeAll();categories.reset([]);tasks.reset([])}function L(a){setTimeout(function(){console.log("Recovering visibility... (toggling tab)");if(p[a.id]===void 0){console.log("Tab not defined. Let's activate it. Man you click fast!");
p[a.id]=true}p[a.id]&&chrome.tabs.sendMessage(a.id,{action:"toggleTab",src:document.location.origin+"/index.html",hidden:w[a.id]})},1E3)}function M(a,b){console.log("Injecting code...");chrome.tabs.executeScript(a.id,{file:"js/chrome/inject.js"},function(){b()})}function N(a){if(x[a.id]){console.log("Toggling to code which was already injected");G(a)}else{x[a.id]=true;a.status=="complete"&&chrome.tabs.executeScript(a.id,{file:"js/chrome/inject.js"},function(){console.log("Toggling after script injected...");
G(a)})}}function G(a){console.log("Toggling tab...");p[a.id]=!p[a.id];chrome.tabs.sendMessage(a.id,{action:"toggleTab",src:document.location.origin+"/index.html",hidden:w[a.id]})}function s(a){e==null?H(a):chrome.windows.get(e.id,function(a){if(a){console.log("Popup already exists, not opening a new one.");chrome.windows.update(e.id,{focused:true})}else H()})}function H(a){a=a?"?highlight="+encodeURIComponent(a):"";chrome.windows.create({url:"/index.html"+a+"#popup",width:286,height:600,focused:true,
type:"panel"},function(a){e=a})}window._gaq=window._gaq||[];_gaq.push(["_setAccount",SERVER_API_URL.indexOf("sm-prod")>-1?"UA-28645084-1":"UA-28645272-1"]);_gaq.push(["_setCustomVar",1,"Chrome Version Code",extensionVersion,1]);u("AnyDO-Version",extensionVersion);window.tasks=void 0;window.categories=void 0;var x={},p={},w={},e=null,f=false,g=new I,F={reset:true,success:E};window.trackPageview=function(a){_gaq.push(["_trackPageview",a])};window.track=function(a){a=c.map(a,function(a){return a});switch(a.length){case 0:case 1:console.error("Google Analytics: You should use at least a Category and an Action");
break;case 2:_gaq.push(["_trackEvent",a[0],a[1]]);break;case 3:_gaq.push(["_trackEvent",a[0],a[1],a[2]]);break;case 4:_gaq.push(["_trackEvent",a[0],a[1],a[2],a[3]])}console.log("reporting event",a)};chrome.windows.onRemoved.addListener(function(a){e&&e.id==a&&(e=null)});OPEN_POPUP?chrome.browserAction.setPopup({popup:"/index.html"}):chrome.browserAction.onClicked.addListener(function(a){console.log("Received click on tab",a);if(a.url.search(/^chrome/)>=0)s();else{if(e){chrome.windows.remove(e.id);
e=null}N(a)}});chrome.tabs.onActiveChanged.addListener(function(a){chrome.tabs.sendMessage(a,{action:"refreshTab"})});chrome.runtime.onMessage.addListener(function(a,b,i){switch(a.action){case "facebookConnectComplete":m.logInWithFacebook(a.access_token,function(){f=true;window.storage.setItem("access_token",a.access_token);r();OPEN_POPUP&&s();chrome.runtime.sendMessage({action:"facebookConnectProcessComplete"})},function(){alert("There was an error logging in with Facebook. Please try again.");window.storage.removeItem("access_token")});
break;case "googleConnectComplete":OPEN_POPUP&&s();break;case "logIn":r();break;case "logOut":D();break;case "tasksFetched":E();break;case "alert":console.log("Got alert message",a);switch(a.alert){case "done":if(tasks)if(tasks.get(a.id)){tasks.get(a.id).markAsChecked();chrome.runtime.sendMessage({action:"refreshTab"})}else console.error("can't find task ID!");else console.error("Can't find the tasks collection!");break;case "snooze":if(tasks){tasks.get(a.id).snoozeTask(6E4*a.minutes);chrome.runtime.sendMessage({action:"refreshTab"})}else console.error("Can't find the tasks collection!");
break;case "dismiss":tasks.get(a.id).dismissAlert(function(){chrome.runtime.sendMessage({action:"refreshTab"})})}n();break;case "refresh":f&&t.updateReminders(categories,tasks,a.task);n();break;case "report":console.log("reporting to GA",a.report);_gaq.push(a.report);break;case "track":track(a.track);break;case "trackPageview":trackPageview(a.track);break;case "openPage":console.log("Opening external page "+a.url);chrome.tabs.create({url:a.url});break;case "updateBadge":n(a.numTasks);break;case "updateHiddenStatus":w[b.tab.id]=
a.hidden;console.log("tab",b.tab.id,"tabsHidden[sender.tab.id]",a.hidden);break;case "popupWindow":s(a.highlightedTask);break;case "closePopup":if(e){chrome.windows.remove(e.id);e=null}break;case "pollServer":o();break;case "startPollingServer":y=setInterval(o,18E5);o();break;case "stopPollingServer":clearInterval(y)}if(a.type=="gmailInit"){r();var d;if(g.getGmailActive(GMAIL_ACTIVE))if(storage.getItem("gmail-tour"))d=false;else{d=true;storage.setItem("gmail-tour",true)}i({tour:d})}a.type=="isGmailActive"&&
i({gmail:g.getGmailActive(GMAIL_ACTIVE),gmailNext:g.getGmailActive(GMAIL_NEXT_ACTIVE)});if(a.type=="gmailAddTask"){b=window[a.dateCategory];if(!b)b=a.dateCategory;B(a.data,b,function(b,d){_gaq.push(["_trackEvent","Gmail","Task Added"]);console.log("added from gmail",d);if(a.data.hasOwnProperty("originalSuggestion")){c.post("http://afternoon-earth-1266.herokuapp.com/raw_email_analytics",{added_as:a.data.title,suggestion:a.data.originalSuggestion,conversation:a.data.conversation});console.log({added_as:a.data.title,
suggestion:a.data.originalSuggestion,conversation:a.data.conversation})}i({success:true})},function(a){a=c.extend({},a,{success:false});i(a)});return true}a.type=="gmailCalendarPick"&&chrome.tabs.sendMessage(b.tab.id,a)});chrome.runtime.onConnect.addListener(function(a){a.onMessage.addListener(function(b){b.type=="isGmailActive"&&a.postMessage({type:"isGmailActive",gmail:g.getGmailActive(GMAIL_ACTIVE),gmailNext:g.getGmailActive(GMAIL_NEXT_ACTIVE)})})});OPEN_POPUP||chrome.tabs.onUpdated.addListener(function(a,
b,c){if(b.status=="complete"&&c.url.search(/^chrome/)!=0&&x[c.id]){console.log("on update completed and already inject and not a chrome page");M(c,function(){L(c)})}});var y=void 0;(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="https://ssl.google-analytics.com/ga.js";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)})();window.onerror=function(a,b,c){_gaq.push(["_trackEvent","Exceptions","Application","["+b+" ("+c+")] "+
a,null,true])};console.log("Setting up timers...");setInterval(A,1E4);A();y=setInterval(o,18E5);o();h.initializeAlerts();console.log("Background page initialized successfully.");m.credentialsSaved()&&m.logInUsingStoredCredentials(function(){r()},function(){console.log("Can't log in for some reason.")})});